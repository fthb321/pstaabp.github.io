
Chapter 13: Parallel Computing
=====

Briefly, parallel computing is a method of running code on multiple processors (or multiple cores of the same processor) at the same time.  In general, this is a difficult task depending on where data is stored and retrieved.  The [Julia Documentation on parallel computing](http://docs.julialang.org/en/stable/manual/parallel-computing/) is a good place to start.

Let's start with something relatively simple. Consider the following code:
```
 function count_heads(n::Int)
    c::Int = 0
    for i=1:n
        c += rand(Bool)
    end
    c
end
```

which mimics flipping a coin `n` times.  We can simulate flipping 10 billion coins and finding the fraction that is heads by the following:

```
@time count_heads(10^10)/10^10
```

which returns
```
29.597828 seconds (6.25 k allocations: 263.473 KB)

0.5000025478
```

or about 30 seconds.  We now wish to run it simultaneously on 2 cores (which is what my machine has).  

To do this, we will need to do two things:

1. put the `count_heads` function in a separate file called "count-heads.jl"

2. determine the number of cores on your machine.  The function `nprocs()` may give you this information.

3. Open up the command line version of julia with the -p option as below.   

4. type
    ```
    @everywhere include('count-heads.jl')
    a= @spawn count_heads(5*10^9); b= @spawn count_heads(5*10^9); @time fetch(a)+fetch(b)
    ```

      and you should see a halving of the time above. My machine reports about 15 seconds.   

5. You can also try spawning more processing if you have more cores.  


###Open up a terminal window

(Terminal on the mac/linux, cmd on windows).  If julia is in the path, just type `julia -p 4`, where 4 is the number of cores.  

###Set a Shortcut on windows

2. Find the shortcut that you use to open Julia. Right-click on it, and select Properties.
3. Click on the Shortcut tab. Find the box called Target.
4. Click in that box, and at the end of the string, add -p n (with n being the number of cores that you found earlier). If the string is enclosed with quotation marks, add -p n after the quotation marks.
5. Click Apply and OK at the bottom of the Properties window.
6. Open Julia with the shortcut that you just modified. Test to see if the arguments worked by doing the count heads exercise in the Week 7 notes. If the first number in RemoteRef() is different in each case, then the arguments have been applied correctly.


### Parallel for loops

One issue with what we did above is that we have to think about spawning to

```
@time nheads = @parallel (+) for i=1:10^10
         Int(rand(Bool))
       end
```

### Writing a parallel card simulator

```
function para_check_hand(N::Int,f::Function)
       local num1= @spawn check_hand(div(N,2),f)
       local num2= @spawn check_hand(div(N,2),f)
       fetch(num1)+fetch(num2)
end
```

and then we can time it:

```
@time para_check_hand(10^7,is_full_house)
```

and this returns:
```
7.577296 seconds (2.68 k allocations: 115.470 KB)
14268
```

to compare it,

```
@time check_hand(10^7,is_full_house)
```

returns
```
15.470629 seconds (160.00 M allocations: 8.643 GB, 5.79% gc time)
14708
```

or twice the time. 
